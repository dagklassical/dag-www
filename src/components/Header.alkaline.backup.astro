---
/* Header component for DAG Klassical with dropdown navigation support.
 *
 * Props:
 * - links: NavEntry[] - Array of navigation links (with optional dropdown arrays)
 * - logoSrc?: string - Logo image source
 * - logoAlt?: string - Logo alt text
 * - class?: string - Additional CSS classes
 *
 * Features:
 * - Dropdown menus for main navigation
 * - Mobile responsive navigation
 * - Accessibility compliant with ARIA labels
 * - DAG Klassical branding
 * - Fixed hamburger menu JavaScript
 */

import type { NavEntry } from "../../Types/types";
import { SITE } from "../alkaline.config";

interface Props {
	links: NavEntry[];
	logoSrc?: string;
	logoAlt?: string;
	class?: string;
}

const { 
	links = [], 
	logoSrc = "/logo-dag-klassical.png", 
	logoAlt = "DAG Klassical",
	class: className = ""
} = Astro.props;

const pathname = new URL(Astro.request.url).pathname;

// Create flattened navigation array with dropdown indicators
const navItems = links.map(link => ({
	...link,
	hasDropdown: link.dropdown && link.dropdown.length > 0,
	isActive: link.href === pathname || (link.dropdown && link.dropdown.some(item => item.href === pathname))
}));
---

<header 
	class:list={[
		"relative w-full bg-theme-primary border-b border-theme-secondary/20",
		"px-4 sm:px-6 lg:px-8 py-4",
		className
	]}
>
	<div class="max-w-7xl mx-auto">
		<div class="flex items-center justify-between">
			<!-- Logo and Site Title -->
			<div class="flex items-center space-x-3">
				<a href="/" class="flex items-center space-x-3 hover:opacity-90 transition-opacity">
					<div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-[#A01008] to-[#F7931A] rounded-lg flex items-center justify-center">
						<span class="text-white font-bold text-sm sm:text-lg">DAG</span>
					</div>
					<div class="hidden sm:block">
						<h1 class="text-xl font-bold text-theme-text">{SITE.title}</h1>
						<p class="text-sm text-theme-text/70">Música Clásica</p>
					</div>
				</a>
			</div>

			<!-- Desktop Navigation -->
			<nav class="hidden lg:flex items-center space-x-1" role="navigation" aria-label="Main navigation">
				{
					navItems.map((item) => (
						<li class="relative group">
							{item.hasDropdown ? (
								<!-- Dropdown menu -->
								<div class="relative">
									<button
										aria-haspopup="true"
										aria-expanded="false"
										class:list={[
											"flex items-center space-x-1 px-4 py-2 rounded-md text-sm font-medium transition-colors",
											"hover:bg-theme-secondary/10 focus:outline-none focus:ring-2 focus:ring-theme-accent",
											item.isActive 
												? "text-theme-accent bg-theme-secondary/5" 
												: "text-theme-text hover:text-theme-accent"
										]}
									>
										<span>{item.text}</span>
										<svg 
											class="w-4 h-4 transition-transform group-hover:rotate-180" 
											fill="none" 
											stroke="currentColor" 
											viewBox="0 0 24 24"
										>
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
										</svg>
									</button>
									
									<!-- Dropdown content -->
									<div class="absolute left-0 mt-2 w-56 bg-theme-primary border border-theme-secondary/20 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
										<div class="py-2">
											{
												item.dropdown?.map((subItem) => (
													<Link
														href={subItem.href}
														class:list={[
															"block px-4 py-2 text-sm transition-colors",
															"hover:bg-theme-secondary/10 hover:text-theme-accent",
															subItem.href === pathname 
																? "text-theme-accent bg-theme-secondary/5" 
																: "text-theme-text"
														]}
														text={subItem.text}
													/>
												))
											}
										</div>
									</div>
								</div>
							) : (
								<!-- Regular link -->
								<Link
									href={item.href}
									class:list={[
										"px-4 py-2 text-sm font-medium transition-colors rounded-md",
										"hover:bg-theme-secondary/10 hover:text-theme-accent focus:outline-none focus:ring-2 focus:ring-theme-accent",
										item.isActive 
											? "text-theme-accent bg-theme-secondary/5" 
											: "text-theme-text"
									]}
									text={item.text}
								/>
							)}
						</li>
					))
				}
			</nav>

			<!-- Mobile menu button -->
			<button 
				id="mobile-menu-button"
				class="lg:hidden p-2 rounded-md text-theme-text hover:bg-theme-secondary/10 focus:outline-none focus:ring-2 focus:ring-theme-accent"
				aria-expanded="false"
				aria-controls="mobile-navigation"
				aria-label="Toggle mobile menu"
			>
				<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
				</svg>
			</button>
		</div>

		<!-- Mobile Navigation -->
		<div 
			id="mobile-navigation"
			class="lg:hidden mt-4 border-t border-theme-secondary/20 pt-4 hidden"
		>
			{
				navItems.map((item) => (
					<div class="mb-2">
						{item.hasDropdown ? (
							<div>
								<div class="font-medium text-theme-text py-2 px-3 border-b border-theme-secondary/10">
									{item.text}
								</div>
								{
									item.dropdown?.map((subItem) => (
										<Link
											href={subItem.href}
											class:list={[
												"block pl-6 py-2 text-sm transition-colors",
												"hover:bg-theme-secondary/10 hover:text-theme-accent",
												subItem.href === pathname 
													? "text-theme-accent bg-theme-secondary/5" 
													: "text-theme-text/80"
											]}
											text={subItem.text}
										/>
									))
								}
							</div>
						) : (
							<Link
								href={item.href}
								class:list={[
									"block py-2 text-sm font-medium transition-colors rounded-md",
									"hover:bg-theme-secondary/10 hover:text-theme-accent focus:outline-none focus:ring-2 focus:ring-theme-accent",
									item.isActive 
										? "text-theme-accent bg-theme-secondary/5" 
										: "text-theme-text"
								]}
								text={item.text}
							/>
						)}
					</div>
				))
			}
		</div>
	</div>
</header>

<!-- FIXED: Mobile menu toggle script -->
<script is:inline>
	// Wait for DOM to be ready
	if (typeof document !== 'undefined') {
		document.addEventListener('DOMContentLoaded', function() {
			const mobileMenuButton = document.getElementById('mobile-menu-button');
			const mobileNavigation = document.getElementById('mobile-navigation');
			
			if (mobileMenuButton && mobileNavigation) {
				// Remove any existing event listeners by cloning
				const newButton = mobileMenuButton.cloneNode(true);
				mobileMenuButton.parentNode.replaceChild(newButton, mobileMenuButton);
				
				newButton.addEventListener('click', function() {
					const isExpanded = newButton.getAttribute('aria-expanded') === 'true';
					newButton.setAttribute('aria-expanded', !isExpanded);
					mobileNavigation.classList.toggle('hidden');
				});

				// Close menu when clicking outside
				document.addEventListener('click', function(event) {
					if (!newButton.contains(event.target) && !mobileNavigation.contains(event.target)) {
						newButton.setAttribute('aria-expanded', 'false');
						mobileNavigation.classList.add('hidden');
					}
				});

				// Close menu on escape key
				document.addEventListener('keydown', function(event) {
					if (event.key === 'Escape') {
						newButton.setAttribute('aria-expanded', 'false');
						mobileNavigation.classList.add('hidden');
					}
				});
			}
		});
	}
</script>