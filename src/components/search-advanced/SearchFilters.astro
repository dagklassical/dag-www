---
// Componente de filtros para búsqueda avanzada

interface SelectedFilters {
  type: string;
  category: string;
  tags: string[];
}

interface Props {
  bind:selectedFilters: SelectedFilters;
  onFilterChange?: () => void;
}

const { selectedFilters, onFilterChange } = Astro.props;

// Opciones de tipos de contenido
const contentTypes = [
  { value: '', label: 'Todos los tipos' },
  { value: 'blog', label: 'Blog' },
  { value: 'music', label: 'Música' },
  { value: 'artist', label: 'Artistas' },
  { value: 'page', label: 'Páginas' },
  { value: 'nft', label: 'NFT' }
];

// Opciones de categorías
const categories = [
  { value: '', label: 'Todas las categorías' },
  { value: 'blog', label: 'Blog' },
  { value: 'music', label: 'Música' },
  { value: 'artists', label: 'Artistas' },
  { value: 'blockchain', label: 'Blockchain' },
  { value: 'nft', label: 'NFT' },
  { value: 'distribucion', label: 'Distribución' },
  { value: 'faq', label: 'FAQ' },
  { value: 'nosotros', label: 'Nosotros' }
];

// Tags populares
const popularTags = [
  'música clásica', 'baroque', 'romantic', 'contemporary', 'bach', 'mozart', 'beethoven',
  'blockchain', 'nft', 'streaming', 'distribución', 'artista', 'compositor',
  'tutorial', 'review', 'noticias', 'análisis', 'blockchain', 'smart contracts'
];

// Manejar cambio de filtro
const handleFilterChange = (filterType: string, value: string) => {
  switch (filterType) {
    case 'type':
      selectedFilters.type = value;
      break;
    case 'category':
      selectedFilters.category = value;
      break;
    case 'tags':
      if (selectedFilters.tags.includes(value)) {
        selectedFilters.tags = selectedFilters.tags.filter(tag => tag !== value);
      } else {
        selectedFilters.tags.push(value);
      }
      break;
  }
  
  if (onFilterChange) {
    onFilterChange();
  }
};

// Verificar si un tag está seleccionado
const isTagSelected = (tag: string) => selectedFilters.tags.includes(tag);

// Limpiar todos los filtros
const clearAllFilters = () => {
  selectedFilters.type = '';
  selectedFilters.category = '';
  selectedFilters.tags = [];
  
  if (onFilterChange) {
    onFilterChange();
  }
};

// Verificar si hay filtros activos
const hasActiveFilters = selectedFilters.type || selectedFilters.category || selectedFilters.tags.length > 0;
---

<div class="search-filters p-4 space-y-6">
  <!-- Filtros principales -->
  <div class="filters-main">
    <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-3">
      Filtros principales
    </h3>
    
    <!-- Filtro por tipo de contenido -->
    <div class="filter-group mb-4">
      <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">
        Tipo de contenido
      </label>
      <select
        class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        value={selectedFilters.type}
        onchange={(e) => handleFilterChange('type', e.target.value)}
      >
        {contentTypes.map((type) => (
          <option value={type.value}>{type.label}</option>
        ))}
      </select>
    </div>
    
    <!-- Filtro por categoría -->
    <div class="filter-group mb-4">
      <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">
        Categoría
      </label>
      <select
        class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        value={selectedFilters.category}
        onchange={(e) => handleFilterChange('category', e.target.value)}
      >
        {categories.map((category) => (
          <option value={category.value}>{category.label}</option>
        ))}
      </select>
    </div>
  </div>
  
  <!-- Filtro por tags -->
  <div class="filters-tags">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-medium text-gray-900 dark:text-white">
        Tags
      </h3>
      {hasActiveFilters && (
        <button
          class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
          onclick={clearAllFilters}
        >
          Limpiar todo
        </button>
      )}
    </div>
    
    <div class="tags-grid grid grid-cols-2 sm:grid-cols-3 gap-2">
      {popularTags.map((tag) => (
        <button
          class={`filter-tag px-3 py-2 text-xs rounded-full border transition-all ${
            isTagSelected(tag)
              ? 'bg-blue-100 dark:bg-blue-900 border-blue-300 dark:border-blue-600 text-blue-800 dark:text-blue-200'
              : 'bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
          }`}
          onclick={() => handleFilterChange('tags', tag)}
          aria-pressed={isTagSelected(tag)}
        >
          <div class="flex items-center space-x-1">
            {isTagSelected(tag) && (
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            )}
            <span>{tag}</span>
          </div>
        </button>
      ))}
    </div>
  </div>
  
  <!-- Filtros activos -->
  {hasActiveFilters && (
    <div class="active-filters">
      <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-3">
        Filtros activos
      </h3>
      <div class="active-filters-list flex flex-wrap gap-2">
        {selectedFilters.type && (
          <div class="active-filter inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
            <span class="capitalize">{selectedFilters.type}</span>
            <button
              class="ml-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
              onclick={() => handleFilterChange('type', '')}
              aria-label="Quitar filtro de tipo"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        )}
        
        {selectedFilters.category && (
          <div class="active-filter inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
            <span>{categories.find(c => c.value === selectedFilters.category)?.label}</span>
            <button
              class="ml-2 text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300"
              onclick={() => handleFilterChange('category', '')}
              aria-label="Quitar filtro de categoría"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        )}
        
        {selectedFilters.tags.map((tag) => (
          <div class="active-filter inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">
            <span>{tag}</span>
            <button
              class="ml-2 text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300"
              onclick={() => handleFilterChange('tags', tag)}
              aria-label={`Quitar tag ${tag}`}
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        ))}
      </div>
    </div>
  )}
</div>

<style>
  .filter-tag {
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }
  
  .filter-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .filter-tag:active {
    transform: translateY(0);
  }
  
  .active-filter {
    animation: slideIn 0.3s ease-out;
  }
  
  .tags-grid {
    max-height: 200px;
    overflow-y: auto;
  }
  
  .tags-grid::-webkit-scrollbar {
    width: 4px;
  }
  
  .tags-grid::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .tags-grid::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.5);
    border-radius: 2px;
  }
  
  .tags-grid::-webkit-scrollbar-thumb:hover {
    background: rgba(156, 163, 175, 0.8);
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  @media (max-width: 640px) {
    .tags-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .filter-tag {
      padding: 8px 12px;
      font-size: 11px;
    }
  }
</style>

<script>
  // Manejo de eventos de filtros
  document.addEventListener('DOMContentLoaded', () => {
    // Hacer tags interactivos
    const tagButtons = document.querySelectorAll('.filter-tag');
    tagButtons.forEach(button => {
      button.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          button.click();
        }
      });
    });
    
    // Focus management
    const firstFilter = document.querySelector('select');
    if (firstFilter) {
      firstFilter.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          const selects = Array.from(document.querySelectorAll('select'));
          const currentIndex = selects.indexOf(e.target);
          
          if (e.key === 'ArrowDown' && currentIndex < selects.length - 1) {
            e.preventDefault();
            selects[currentIndex + 1].focus();
          }
          
          if (e.key === 'ArrowUp' && currentIndex > 0) {
            e.preventDefault();
            selects[currentIndex - 1].focus();
          }
        }
      });
    }
  });
</script>