---
// Layout Base - DAG Klassical (CON SEO AVANZADO)
// Archivo: src/layouts/Layout.astro
// Propósito: Layout base con CSS centralizado + SEO completo + Performance
---

// Props del layout
interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article' | 'profile';
  artistName?: string;
  keywords?: string;
  canonical?: string;
  noindex?: boolean;
  structuredData?: object;
}

const { 
  title, 
  description = "DAG Klassical - Plataforma revolucionaria de música clásica con tecnología blockchain y NFTs",
  image = "/logo-dag.svg",
  type = "website",
  artistName,
  keywords = "música clásica, blockchain, NFTs, arte digital, DAG Klassical, Virginia Ramírez",
  canonical,
  noindex = false,
  structuredData
} = Astro.props;

// CSS Centralizado Importado
import '../styles/global.css';

// Componentes Centralizados
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Meta tags avanzados
const baseUrl = import.meta.env.BASE_URL || '';
const fullTitle = title.includes('DAG Klassical') ? title : `${title} | DAG Klassical`;
const fullImage = image.startsWith('http') ? image : `${baseUrl}${image}`;
const canonicalUrl = canonical || new URL(Astro.url.pathname, Astro.site).toString();

// Structured Data automático para Organización
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "DAG Klassical",
  "url": Astro.site?.toString() || `https://dagklassical.github.io${baseUrl}`,
  "logo": `${baseUrl}/logo-dag.svg`,
  "description": description,
  "sameAs": [
    "https://github.com/dagklassical",
    "https://twitter.com/dagklassical"
  ]
};

// Structured Data para Artistas/Perfiles
const artistSchema = artistName ? {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": artistName,
  "url": canonicalUrl,
  "image": fullImage,
  "description": description,
  "jobTitle": "Música Clásica",
  "worksFor": {
    "@type": "Organization",
    "name": "DAG Klassical"
  }
} : null;

// Structured Data para Contenido de Artículo
const articleSchema = type === 'article' ? {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": fullImage,
  "author": artistName ? {
    "@type": "Person",
    "name": artistName
  } : {
    "@type": "Organization",
    "name": "DAG Klassical"
  },
  "publisher": {
    "@type": "Organization",
    "name": "DAG Klassical",
    "logo": {
      "@type": "ImageObject",
      "url": `${baseUrl}/logo-dag.svg`
    }
  },
  "datePublished": new Date().toISOString(),
  "dateModified": new Date().toISOString()
} : null;

// Structured Data combinado
const allStructuredData = {
  "@graph": [
    organizationSchema,
    ...(artistSchema ? [artistSchema] : []),
    ...(articleSchema ? [articleSchema] : []),
    ...(structuredData ? [structuredData] : [])
  ]
};
---

<!DOCTYPE html>
<html lang="es" prefix="og: https://ogp.me/ns#">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- === META TAGS SEO AVANZADOS === -->
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="DAG Klassical" />
    <meta name="robots" content={noindex ? "noindex, nofollow" : "index, follow"} />
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- === META TAGS OPEN GRAPH COMPLETOS === -->
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={fullImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="DAG Klassical" />
    <meta property="og:locale" content="es_ES" />
    <meta property="og:locale:alternate" content="en_US" />
    
    <!-- === META TAGS TWITTER CARDS === -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={fullImage} />
    <meta name="twitter:creator" content="@dagklassical" />
    
    <!-- === META TAGS ADICIONALES === -->
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#1a1a1a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- === FAVICON Y ÍCONOS COMPLETOS === -->
    <link rel="icon" type="image/svg+xml" href="/logo-dag.svg" />
    <link rel="apple-touch-icon" href="/logo-dag.svg" />
    <link rel="shortcut icon" href="/logo-dag.svg" />
    
    <!-- === STRUCTURED DATA (JSON-LD) === -->
    <script type="application/ld+json">
      {JSON.stringify(allStructuredData, null, 2)}
    </script>
    
    <!-- === PERFORMANCE OPTIMIZATIONS === -->
    <!-- Preconnect para recursos externos -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- DNS Prefetch para APIs externas -->
    <link rel="dns-prefetch" href="https://api.dagklassical.com" />
    <link rel="dns-prefetch" href="https://gateway.pinata.cloud" />
    
    <!-- Preload para recursos críticos -->
    <link rel="preload" href="/styles/global.css" as="style" />
    <link rel="preload" href="/logo-dag.svg" as="image" />
    
    <!-- CSS Critical inline -->
    <style>
      /* Critical CSS para renderizado inmediato */
      body { 
        margin: 0; 
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
        line-height: 1.6;
        color: #333;
        background-color: #fff;
      }
      
      /* Skip link para accesibilidad */
      .skip-link { 
        position: absolute; 
        top: -40px; 
        left: 6px; 
        z-index: 10000; 
        background: #000;
        color: #fff;
        padding: 8px 16px;
        text-decoration: none;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .skip-link:focus { 
        top: 6px; 
      }
      
      /* Loading state */
      .loading {
        opacity: 0;
        animation: fadeIn 0.3s ease-in-out forwards;
      }
      
      @keyframes fadeIn {
        to { opacity: 1; }
      }
    </style>
  </head>
  
  <body class="loading">
    <!-- Skip to content para accesibilidad -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Header Centralizado -->
    <Header />
    
    <!-- Contenido Principal -->
    <main id="main-content" class="main-content" role="main">
      <slot />
    </main>
    
    <!-- Footer Centralizado -->
    <Footer />
    
    <!-- Performance: Subresource Integrity y lazy loading -->
    <script>
      // Remover clase loading cuando el DOM esté listo
      document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.remove('loading');
      });
      
      // Service Worker registration para cache
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').catch(function(error) {
            console.log('Service Worker registration failed:', error);
          });
        });
      }
    </script>
  </body>
</html>

<style>
  /* Estilos específicos del layout con SEO optimizado */
  .main-content {
    min-height: calc(100vh - 200px);
    padding-top: var(--spacing-lg, 2rem);
    /* Optimización para LCP */
    content-visibility: auto;
    contain-intrinsic-size: 500px;
  }
  
  /* Accesibilidad mejorada */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  /* Focus visible mejorado para navegación por teclado */
  *:focus-visible {
    outline: 2px solid var(--color-primary, #007bff);
    outline-offset: 2px;
    border-radius: 2px;
  }
  
  /* Skip to content link mejorado */
  .skip-link {
    background: var(--color-primary, #007bff);
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    text-decoration: none;
    z-index: 10000;
    transition: top 0.3s ease;
    font-weight: 500;
  }
  
  .skip-link:focus {
    top: 6px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* Optimización de rendimiento */
  img {
    loading: lazy;
    decoding: async;
  }
  
  /* Animación de carga mejorada */
  .loading {
    transition: opacity 0.3s ease-in-out;
  }
</style>